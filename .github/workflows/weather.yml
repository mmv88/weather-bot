name: Weather and Birthday Bot

on:  
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: pip install requests pytz
      
      - name: Send notifications
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          BIRTHDAYS: ${{ secrets.BIRTHDAYS }}
        run: |
          python3 <<'PYEOF'
          import requests, os, sys
          from datetime import datetime, timedelta
          import pytz
          import json
          
          t = os.environ['BOT_TOKEN']
          c = os.environ['CHAT_ID'].strip()
          k = os.environ['API_KEY']
          tz = pytz.timezone('Asia/Yekaterinburg')
          now = datetime.now(tz)

          MORNING_HOUR = 7
          EVENING_HOUR = 17
          QUOTE_HOUR = 17  # –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ü–∏—Ç–∞—Ç—ã (12:00 –ø–æ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—É)
          
          def send_message(text, thread_id=10):
              response = requests.post(
                  f'https://api.telegram.org/bot{t}/sendMessage',
                  json={
                      'chat_id': int(c),
                      'message_thread_id': thread_id,
                      'text': text,
                      'parse_mode': 'HTML'
                  },
                  timeout=10
              )
              if response.status_code != 200:
                  print(f"Telegram response: {response.text}")
                  response.raise_for_status()
              return response
          
          # –í 7:00 —É—Ç—Ä–∞ - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏–π
          if now.hour == MORNING_HOUR:
              try:
                  birthdays_json = os.environ.get('BIRTHDAYS', '[]')
                  birthdays = json.loads(birthdays_json)
                  
                  today = now.date()
                  tomorrow = (now + timedelta(days=1)).date()
                  
                  for person in birthdays:
                      name = person['name']
                      bday_str = person['date']
                      
                      parts = bday_str.split('.')
                      day, month = int(parts[0]), int(parts[1])
                      year = int(parts[2]) if len(parts) > 2 else None
                      
                      bday_this_year = datetime(today.year, month, day).date()
                      
                      # –ó–∞–≤—Ç—Ä–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è
                      if bday_this_year == tomorrow:
                          age_text = ""
                          if year:
                              age = today.year - year + 1
                              age_text = f" (–∏—Å–ø–æ–ª–Ω–∏—Ç—Å—è {age})"
                          msg = f"üéÇ <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!</b>\n\n–ó–∞–≤—Ç—Ä–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —É <b>{name}</b>{age_text}!\n\n–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø–æ–∑–¥—Ä–∞–≤–∏—Ç—å! üéâ"
                          send_message(msg)
                          print(f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –î–† {name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–∑–∞–≤—Ç—Ä–∞)")
                      
                      # –°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è
                      elif bday_this_year == today:
                          age_text = ""
                          if year:
                              age = today.year - year
                              age_text = f" {age} –ª–µ—Ç"
                          msg = f"üéâüéà <b>–° –î–Ω—ë–º –†–æ–∂–¥–µ–Ω–∏—è!</b> üéàüéâ\n\n<b>{name}</b>{age_text}!\n\n–ñ–µ–ª–∞–µ–º —Å—á–∞—Å—Ç—å—è, –∑–¥–æ—Ä–æ–≤—å—è –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∂–µ–ª–∞–Ω–∏–π! üéÅüéÇ"
                          send_message(msg)
                          print(f"‚úÖ –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ {name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
                          
              except Exception as ex:
                  print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –î–†: {ex}")
          
          # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ü–∏—Ç–∞—Ç—ã
          if now.hour == QUOTE_HOUR:
              try:
                  quote_url = "https://api.forismatic.com/api/1.0/"
                  quote_params = {
                      'method': 'getQuote',
                      'format': 'json',
                      'lang': 'ru'
                  }
                  
                  quote_response = requests.get(quote_url, params=quote_params, timeout=10)
                  quote_data = quote_response.json()
                  
                  quote_text = quote_data.get('quoteText', '').strip()
                  quote_author = quote_data.get('quoteAuthor', '').strip()
                  
                  if quote_text:
                      author_line = f"\n\n‚Äî <i>{quote_author}</i>" if quote_author else ""
                      quote_msg = f"üí≠ <b>–¶–∏—Ç–∞—Ç–∞ –¥–Ω—è</b>\n\n¬´{quote_text}¬ª{author_line}"
                      send_message(quote_msg)
                      print(f"‚úÖ –¶–∏—Ç–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞")
                  else:
                      print("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–∏—Ç–∞—Ç—É")
                      
              except Exception as ex:
                  print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–∏—Ç–∞—Ç—ã: {ex}")
          
          # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–≥–æ–¥—ã
          try:
              # –í 7:00 - –ø–æ–≥–æ–¥–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (—Ç–µ–∫—É—â–∞—è)
              # –í 20:00 - –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
              if now.hour == MORNING_HOUR:
                  weather_type = "—Å–µ–≥–æ–¥–Ω—è"
                  w = requests.get('https://api.openweathermap.org/data/2.5/weather', params={
                      'q': 'Chelyabinsk,RU',
                      'appid': k,
                      'units': 'metric',
                      'lang': 'ru'
                  }, timeout=10).json()
              elif now.hour == EVENING_HOUR:
                  weather_type = "–∑–∞–≤—Ç—Ä–∞"
                  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≥–Ω–æ–∑ (–±–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å, –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ –ø–æ–ª–¥–µ–Ω—å)
                  forecast = requests.get('https://api.openweathermap.org/data/2.5/forecast', params={
                      'q': 'Chelyabinsk,RU',
                      'appid': k,
                      'units': 'metric',
                      'lang': 'ru'
                  }, timeout=10).json()
                  
                  # –ë–µ—Ä–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –æ–∫–æ–ª–æ 12:00
                  tomorrow_noon = None
                  for item in forecast['list']:
                      forecast_time = datetime.fromtimestamp(item['dt'], tz=tz)
                      if forecast_time.date() == (now + timedelta(days=1)).date():
                          if 10 <= forecast_time.hour <= 14:
                              tomorrow_noon = item
                              break
                  
                  if tomorrow_noon:
                      w = {
                          'weather': tomorrow_noon['weather'],
                          'main': tomorrow_noon['main'],
                          'wind': tomorrow_noon['wind']
                      }
                  else:
                      # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
                      w = {
                          'weather': forecast['list'][8]['weather'],
                          'main': forecast['list'][8]['main'],
                          'wind': forecast['list'][8]['wind']
                      }
              else:
                  print(f"‚è≠Ô∏è –ù–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ–≥–æ–¥—ã (—Ç–µ–∫—É—â–∏–π —á–∞—Å: {now.hour})")
                  sys.exit(0)  # –í—ã—Ö–æ–¥, –µ—Å–ª–∏ –Ω–µ 7:00 –∏ –Ω–µ 20:00
              
              if 'cod' in w and w['cod'] != 200:
                  raise Exception(f"OpenWeather API error: {w.get('message', 'Unknown error')}")
              
              e = '‚òÄÔ∏è'
              d = w['weather'][0]['description'].lower()
              if '–¥–æ–∂–¥—å' in d or '–ª–∏–≤–µ–Ω—å' in d: e = 'üåßÔ∏è'
              elif '–æ–±–ª–∞—á–Ω–æ' in d or '–ø–∞—Å–º—É—Ä–Ω–æ' in d: e = '‚òÅÔ∏è'
              elif '—Å–Ω–µ–≥' in d: e = '‚ùÑÔ∏è'
              elif '–≥—Ä–æ–∑–∞' in d: e = '‚ö°'
              elif '—Ç—É–º–∞–Ω' in d: e = 'üå´Ô∏è'
              
              temp = round(w['main']['temp'], 1)
              feels = round(w['main']['feels_like'], 1)
              pressure_mmhg = round(w['main']['pressure'] * 0.750062)
              
              header = "—Å–µ–≥–æ–¥–Ω—è" if now.hour == MORNING_HOUR else "–Ω–∞ –∑–∞–≤—Ç—Ä–∞"
              m = f"""{e} <b>–ü–æ–≥–æ–¥–∞ –≤ –ß–µ–ª—è–±–∏–Ω—Å–∫–µ {header}</b>

          üå°Ô∏è {temp}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ {feels}¬∞C)
          üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: {w['main']['humidity']}%
          üìä –î–∞–≤–ª–µ–Ω–∏–µ: {pressure_mmhg} –º–º —Ä—Ç. —Å—Ç.
          üí® –í–µ—Ç–µ—Ä: {w['wind']['speed']} –º/—Å
          üå§Ô∏è {w['weather'][0]['description'].capitalize()}
          ‚è∞ {now.strftime('%d.%m.%Y %H:%M')}"""
              
              send_message(m)
              print(f'‚úÖ –ü–æ–≥–æ–¥–∞ {weather_type} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!')
              
          except Exception as ex:
              print(f'‚ùå –û—à–∏–±–∫–∞ –ø–æ–≥–æ–¥—ã: {ex}')
              sys.exit(1)
          PYEOF
