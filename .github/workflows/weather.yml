name: Weather Bot

on:
  schedule:
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 08:00 –∏ 18:00 –ø–æ –ú–°–ö (–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è = UTC+3)
    # –í GitHub Actions –≤—Ä–µ–º—è —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ UTC
    # 08:00 –ú–°–ö = 05:00 UTC
    # 18:00 –ú–°–ö = 15:00 UTC
    - cron: '0 5,15 * * *'
  
  # –î–ª—è —Ç–µ—Å—Ç–∞ ‚Äî –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É main –∏–ª–∏ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  send-weather:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Send weather to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        run: |
          python3 << 'SCRIPT'
          import requests
          import os
          import sys
          from datetime import datetime
          import pytz

          print("üöÄ –ó–∞–ø—É—Å–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–≥–æ–¥—ã...")

          # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
          BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN')
          CHAT_ID = os.environ.get('TELEGRAM_CHAT_ID')
          API_KEY = os.environ.get('OPENWEATHER_API_KEY')
          
          if not all([BOT_TOKEN, CHAT_ID, API_KEY]):
              print("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!")
              sys.exit(1)

          # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ—Ä–æ–¥–∞ (–∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à)
          CITY = "Moscow"  # ‚Üê –°–Æ–î–ê –í–ü–ò–®–ò–¢–ï –í–ê–® –ì–û–†–û–î
          COUNTRY_CODE = "RU"  # –ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

          # –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É
          print(f"üì° –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–≥–æ–¥—É –¥–ª—è {CITY}...")
          url = "https://api.openweathermap.org/data/2.5/weather"
          params = {
              "q": f"{CITY},{COUNTRY_CODE}" if COUNTRY_CODE else CITY,
              "appid": API_KEY,
              "units": "metric",
              "lang": "ru"
          }

          try:
              response = requests.get(url, params=params, timeout=10)
              response.raise_for_status()
              data = response.json()
              
              print(f"‚úÖ –ü–æ–≥–æ–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞: {data['weather'][0]['description']}")

              # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
              city_name = data["name"]
              temp = data["main"]["temp"]
              feels_like = data["main"]["feels_like"]
              humidity = data["main"]["humidity"]
              pressure = data["main"]["pressure"]
              weather_desc = data["weather"][0]["description"].capitalize()
              wind_speed = data["wind"]["speed"]

              # –≠–º–æ–¥–∑–∏ –ø–æ –ø–æ–≥–æ–¥–µ
              emoji = "‚òÄÔ∏è"
              desc_lower = weather_desc.lower()
              if "–¥–æ–∂–¥—å" in desc_lower or "–ª–∏–≤–µ–Ω—å" in desc_lower:
                  emoji = "üåßÔ∏è"
              elif "–æ–±–ª–∞—á–Ω–æ" in desc_lower or "–ø–∞—Å–º—É—Ä–Ω–æ" in desc_lower:
                  emoji = "‚òÅÔ∏è"
              elif "—Å–Ω–µ–≥" in desc_lower:
                  emoji = "‚ùÑÔ∏è"
              elif "–≥—Ä–æ–∑–∞" in desc_lower:
                  emoji = "‚ö°"
              elif "—Ç—É–º–∞–Ω" in desc_lower or "–º–≥–ª–∞" in desc_lower:
                  emoji = "üå´Ô∏è"

              # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
              message = f"""{emoji} <b>–ü–æ–≥–æ–¥–∞ –≤ {city_name}</b>

üå°Ô∏è {temp}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ {feels_like}¬∞C)
üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: {humidity}%
–¥–∞–≤–ª–µ–Ω–∏–µ: {pressure} –≥–ü–∞
üí® –í–µ—Ç–µ—Ä: {wind_speed} –º/—Å
üå§Ô∏è {weather_desc}

‚è∞ {datetime.now(pytz.timezone('Europe/Moscow')).strftime('%d.%m.%Y %H:%M')}"""

              # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
              print("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram...")
              tg_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
              tg_response = requests.post(
                  tg_url,
                  json={
                      "chat_id": CHAT_ID,
                      "text": message,
                      "parse_mode": "HTML"
                  },
                  timeout=10
              )
              
              tg_response.raise_for_status()
              print("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")

          except requests.exceptions.RequestException as e:
              print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: {e}")
              sys.exit(1)
          except KeyError as e:
              print(f"‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ–≥–æ–¥—ã: {e}")
              print(f"–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç: {data}")
              sys.exit(1)
          except Exception as e:
              print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
              sys.exit(1)

          SCRIPT
