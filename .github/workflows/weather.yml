name: Weather Bot

on:
  schedule:
    - cron: '0 5,15 * * *'
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  send-weather:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: pip install requests pytz
      
      - name: Send weather
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        run: |
          python3 <<'PYEOF'
          import requests, os, sys
          from datetime import datetime
          import pytz

          t = os.environ['BOT_TOKEN']
          c = ''.join(filter(str.isdigit, os.environ['CHAT_ID']))
          k = os.environ['API_KEY']

          try:
              w = requests.get('https://api.openweathermap.org/data/2.5/weather', params={
                  'q': 'Moscow,RU',
                  'appid': k,
                  'units': 'metric',
                  'lang': 'ru'
              }, timeout=10).json()
              
              if 'cod' in w and w['cod'] != 200:
                  raise Exception(f"OpenWeather API error: {w.get('message', 'Unknown error')}")
              
              e = '‚òÄÔ∏è'
              d = w['weather'][0]['description'].lower()
              if '–¥–æ–∂–¥—å' in d or '–ª–∏–≤–µ–Ω—å' in d: e = 'üåßÔ∏è'
              elif '–æ–±–ª–∞—á–Ω–æ' in d or '–ø–∞—Å–º—É—Ä–Ω–æ' in d: e = '‚òÅÔ∏è'
              elif '—Å–Ω–µ–≥' in d: e = '‚ùÑÔ∏è'
              elif '–≥—Ä–æ–∑–∞' in d: e = '‚ö°'
              elif '—Ç—É–º–∞–Ω' in d: e = 'üå´Ô∏è'
              
              temp = round(w['main']['temp'], 1)
              feels = round(w['main']['feels_like'], 1)
              
              m = f"""{e} <b>–ü–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–µ</b>

          üå°Ô∏è {temp}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ {feels}¬∞C)
          üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: {w['main']['humidity']}%
          üìä –î–∞–≤–ª–µ–Ω–∏–µ: {w['main']['pressure']} –≥–ü–∞
          üí® –í–µ—Ç–µ—Ä: {w['wind']['speed']} –º/—Å
          üå§Ô∏è {w['weather'][0]['description'].capitalize()}
          ‚è∞ {datetime.now(pytz.timezone('Europe/Moscow')).strftime('%d.%m.%Y %H:%M')}"""
              
              response = requests.post(
                  f'https://api.telegram.org/bot{t}/sendMessage',
                  json={
                      'chat_id': int(c),
                      'text': m,
                      'parse_mode': 'HTML'
                  },
                  timeout=10
              )
              
              if response.status_code != 200:
                  print(f"Telegram response: {response.text}")
                  response.raise_for_status()
              
              print('‚úÖ –ü–æ–≥–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!')
              
          except Exception as ex:
              print(f'‚ùå –û—à–∏–±–∫–∞: {ex}')
              sys.exit(1)
          PYEOF
