name: Weather and Birthday Bot

on:
  schedule:
    - cron: '0 3 * * *'  # 8:00 –ø–æ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—É (–ø—Ä–æ–≤–µ—Ä–∫–∞ –î–†)
    - cron: '0 2,9 * * *'  # –ü–æ–≥–æ–¥–∞ –≤ 10:00 –∏ 20:00 –ø–æ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—É
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: pip install requests pytz
      
      - name: Send notifications
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          BIRTHDAYS: ${{ secrets.BIRTHDAYS }}
        run: |
          python3 <<'PYEOF'
          import requests, os, sys
          from datetime import datetime, timedelta
          import pytz
          import json
          
          t = os.environ['BOT_TOKEN']
          c = os.environ['CHAT_ID'].strip()
          k = os.environ['API_KEY']
          tz = pytz.timezone('Asia/Yekaterinburg')
          now = datetime.now(tz)
          
          def send_message(text, thread_id=10):
              response = requests.post(
                  f'https://api.telegram.org/bot{t}/sendMessage',
                  json={
                      'chat_id': int(c),
                      'message_thread_id': thread_id,
                      'text': text,
                      'parse_mode': 'HTML'
                  },
                  timeout=10
              )
              if response.status_code != 200:
                  print(f"Telegram response: {response.text}")
                  response.raise_for_status()
              return response
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏–π
          try:
              birthdays_json = os.environ.get('BIRTHDAYS', '[]')
              birthdays = json.loads(birthdays_json)
              
              today = now.date()
              tomorrow = (now + timedelta(days=1)).date()
              
              for person in birthdays:
                  name = person['name']
                  bday_str = person['date']  # —Ñ–æ—Ä–º–∞—Ç: "DD.MM" –∏–ª–∏ "DD.MM.YYYY"
                  
                  parts = bday_str.split('.')
                  day, month = int(parts[0]), int(parts[1])
                  year = int(parts[2]) if len(parts) > 2 else None
                  
                  # –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —ç—Ç–æ–º –≥–æ–¥—É
                  bday_this_year = datetime(today.year, month, day).date()
                  
                  # –ó–∞–≤—Ç—Ä–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è
                  if bday_this_year == tomorrow:
                      age_text = ""
                      if year:
                          age = today.year - year + 1
                          age_text = f" (–∏—Å–ø–æ–ª–Ω–∏—Ç—Å—è {age})"
                      msg = f"üéÇ <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!</b>\n\n–ó–∞–≤—Ç—Ä–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —É <b>{name}</b>{age_text}!\n\n–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø–æ–∑–¥—Ä–∞–≤–∏—Ç—å! üéâ"
                      send_message(msg)
                      print(f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –î–† {name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–∑–∞–≤—Ç—Ä–∞)")
                  
                  # –°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è
                  elif bday_this_year == today:
                      age_text = ""
                      if year:
                          age = today.year - year
                          age_text = f" {age} –ª–µ—Ç"
                      msg = f"üéâüéà <b>–° –î–Ω—ë–º –†–æ–∂–¥–µ–Ω–∏—è!</b> üéàüéâ\n\n<b>{name}</b>{age_text}!\n\n–ñ–µ–ª–∞–µ–º —Å—á–∞—Å—Ç—å—è, –∑–¥–æ—Ä–æ–≤—å—è –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∂–µ–ª–∞–Ω–∏–π! üéÅüéÇ"
                      send_message(msg)
                      print(f"‚úÖ –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ {name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
                      
          except Exception as ex:
              print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –î–†: {ex}")
          
          # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–≥–æ–¥—ã (—Ç–æ–ª—å–∫–æ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è)
          hour = now.hour
          if hour in [10, 20]:  # 10:00 –∏ 20:00 –ø–æ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—É (5 –∏ 15 UTC)
              try:
                  w = requests.get('https://api.openweathermap.org/data/2.5/weather', params={
                      'q': 'Chelyabinsk,RU',
                      'appid': k,
                      'units': 'metric',
                      'lang': 'ru'
                  }, timeout=10).json()
                  
                  if 'cod' in w and w['cod'] != 200:
                      raise Exception(f"OpenWeather API error: {w.get('message', 'Unknown error')}")
                  
                  e = '‚òÄÔ∏è'
                  d = w['weather'][0]['description'].lower()
                  if '–¥–æ–∂–¥—å' in d or '–ª–∏–≤–µ–Ω—å' in d: e = 'üåßÔ∏è'
                  elif '–æ–±–ª–∞—á–Ω–æ' in d or '–ø–∞—Å–º—É—Ä–Ω–æ' in d: e = '‚òÅÔ∏è'
                  elif '—Å–Ω–µ–≥' in d: e = '‚ùÑÔ∏è'
                  elif '–≥—Ä–æ–∑–∞' in d: e = '‚ö°'
                  elif '—Ç—É–º–∞–Ω' in d: e = 'üå´Ô∏è'
                  
                  temp = round(w['main']['temp'], 1)
                  feels = round(w['main']['feels_like'], 1)
                  pressure_mmhg = round(w['main']['pressure'] * 0.750062)
                  
                  m = f"""{e} <b>–ü–æ–≥–æ–¥–∞ –≤ –ß–µ–ª—è–±–∏–Ω—Å–∫–µ</b>
          üå°Ô∏è {temp}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ {feels}¬∞C)
          üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: {w['main']['humidity']}%
          üìä –î–∞–≤–ª–µ–Ω–∏–µ: {pressure_mmhg} –º–º —Ä—Ç. —Å—Ç.
          üí® –í–µ—Ç–µ—Ä: {w['wind']['speed']} –º/—Å
          üå§Ô∏è {w['weather'][0]['description'].capitalize()}
          ‚è∞ {now.strftime('%d.%m.%Y %H:%M')}"""
                  
                  send_message(m)
                  print('‚úÖ –ü–æ–≥–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!')
                  
              except Exception as ex:
                  print(f'‚ùå –û—à–∏–±–∫–∞ –ø–æ–≥–æ–¥—ã: {ex}')
                  sys.exit(1)
          PYEOF
