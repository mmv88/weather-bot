import requests, os, sys
from datetime import datetime
import pytz

t = os.environ['BOT_TOKEN']
c = ''.join(filter(str.isdigit, os.environ['CHAT_ID']))
k = os.environ['API_KEY']

try:
    w = requests.get('https://api.openweathermap.org/data/2.5/weather', params={
        'q': 'Moscow,RU',
        'appid': k,
        'units': 'metric',
        'lang': 'ru'
    }, timeout=10).json()
    
    if 'cod' in w and w['cod'] != 200:
        raise Exception(f"OpenWeather API error: {w.get('message', 'Unknown error')}")
    
    e = 'â˜€ï¸'
    d = w['weather'][0]['description'].lower()
    if 'Ğ´Ğ¾Ğ¶Ğ´ÑŒ' in d or 'Ğ»Ğ¸Ğ²ĞµĞ½ÑŒ' in d: e = 'ğŸŒ§ï¸'
    elif 'Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ğ¾' in d or 'Ğ¿Ğ°ÑĞ¼ÑƒÑ€Ğ½Ğ¾' in d: e = 'â˜ï¸'
    elif 'ÑĞ½ĞµĞ³' in d: e = 'â„ï¸'
    elif 'Ğ³Ñ€Ğ¾Ğ·Ğ°' in d: e = 'âš¡'
    elif 'Ñ‚ÑƒĞ¼Ğ°Ğ½' in d: e = 'ğŸŒ«ï¸'
    
    temp = round(w['main']['temp'], 1)
    feels = round(w['main']['feels_like'], 1)
    
    m = f"""{e} <b>ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ² ĞœĞ¾ÑĞºĞ²Ğµ</b>

ğŸŒ¡ï¸ {temp}Â°C (Ğ¾Ñ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº {feels}Â°C)
ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ: {w['main']['humidity']}%
ğŸ“Š Ğ”Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: {w['main']['pressure']} Ğ³ĞŸĞ°
ğŸ’¨ Ğ’ĞµÑ‚ĞµÑ€: {w['wind']['speed']} Ğ¼/Ñ
ğŸŒ¤ï¸ {w['weather'][0]['description'].capitalize()}
â° {datetime.now(pytz.timezone('Europe/Moscow')).strftime('%d.%m.%Y %H:%M')}"""
    
    response = requests.post(
        f'https://api.telegram.org/bot{t}/sendMessage',
        json={
            'chat_id': int(c),
            'text': m,
            'parse_mode': 'HTML'
        },
        timeout=10
    )
    
    if response.status_code != 200:
        print(f"Telegram response: {response.text}")
        response.raise_for_status()
    
    print('âœ… ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°!')
    
except Exception as ex:
    print(f'âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: {ex}')
    sys.exit(1)
